name: CI/CD Pipeline (GHCR, env-aware)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "staging", "dev" ]
  pull_request:
    branches: [ "main", "staging", "dev" ]

env:
  IMAGE_NAME: dummy-branch-app

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute owner lowercase
        run: |
          OWNER_RAW="${{ github.repository_owner }}"
          OWNER_LOWER=$(echo "$OWNER_RAW" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_RAW=$OWNER_RAW" >> $GITHUB_ENV
          echo "OWNER_LOWER=$OWNER_LOWER" >> $GITHUB_ENV
          echo "IMAGE_ID=ghcr.io/$OWNER_LOWER/${IMAGE_NAME}" >> $GITHUB_ENV

      - name: Debug owner + image_id
        run: |
          echo "OWNER_RAW=$OWNER_RAW"
          echo "OWNER_LOWER=$OWNER_LOWER"
          echo "IMAGE_ID=$IMAGE_ID"

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build Docker image (SHA tag)
        run: |
          docker build -t ${IMAGE_ID}:${GITHUB_SHA} .

      - name: Compute env tag (based on branch)
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            ENV_TAG="prod-latest"
          elif [[ "${GITHUB_REF}" == "refs/heads/staging" ]]; then
            ENV_TAG="staging-latest"
          elif [[ "${GITHUB_REF}" == "refs/heads/dev" ]]; then
            ENV_TAG="dev-latest"
          else
            ENV_TAG="pr-${GITHUB_RUN_ID}"
          fi

          echo "ENV_TAG=$ENV_TAG" >> $GITHUB_ENV
          docker tag ${IMAGE_ID}:${GITHUB_SHA} ${IMAGE_ID}:${ENV_TAG}

      - name: Trivy Security Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ env.OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true

      - name: Push images to GHCR
        run: |
          echo "Pushing SHA tag"
          docker push ${IMAGE_ID}:${GITHUB_SHA}

          if [[ "${GITHUB_REF}" == "refs/heads/main" || \
                "${GITHUB_REF}" == "refs/heads/staging" || \
                "${GITHUB_REF}" == "refs/heads/dev" ]]; then
            echo "Pushing environment tag: ${ENV_TAG}"
            docker push ${IMAGE_ID}:${ENV_TAG}
          else
            echo "Skipping env tag for non-target branches."
          fi
